class Project < ApplicationRecord

  # Validate presence of required fields
  validates :key, presence: true, text_key: true, uniqueness: true
  validates :name, presence: true
  validates :description, presence: true

  serialize :gh_languages, Hash

  # Validate github link is HTTPS, if present
  #validates :github_link, HTTPS: true

  # Retrieve data from the associated GitHub repository, if it exists
  # Mirrors HTML status codes as much as possible
  def github_data(connection = nil)

    return {message: 'No linked repository', status: 404} unless repo_name.present?

    # Load relevant configuration fields
    github_base_url = Rails.configuration.github_base_url
    gh_user = github_user || Rails.configuration.github_user

    # Only permit Faraday connections so we know what we're getting
    conn = if connection.is_a?(Faraday::Connection)
             connection
           else
             Faraday::Connection.new("https://#{github_base_url}") do |c|
               c.adapter Faraday.default_adapter
               c.headers['Content-Type'] = 'application/json;charset=utf-8'
               c.headers['Accept'] = 'application/vnd.github.v3+json'
             end
           end

    # Fetch repo data from Github API
    repo_request = conn.get "repos/#{gh_user}/#{repo_name}"

    # Only construct the attributes hash if the request succeeded
    return {message: 'Request error', status: repo_request.status} unless repo_request.status == 200

    repo_json = JSON.parse(repo_request.body)

    # TODO: This should probably be moved somewhere global
    time_format = '%Y-%m-%dT%H:%M:%S'

    output = {
        status: 200,
        message: 'Success',
        attributes: {
            gh_url: repo_json['html_url'],
            gh_description: repo_json['description'],
            gh_created_at: DateTime.strptime(repo_json['created_at'], time_format),
            gh_last_pushed_at: DateTime.strptime(repo_json['pushed_at'], time_format),
            gh_last_updated_at: DateTime.strptime(repo_json['updated_at'], time_format),
            gh_clone_url: repo_json['clone_url'],
            gh_homepage: repo_json['homepage'],
            gh_size: repo_json['size'],
            gh_license: repo_json['license'],
            gh_languages: nil
        }
    }

    # Try to get additional language data
    language_request = conn.get "repos/#{gh_user}/#{repo_name}/languages"
    if language_request.status == 200
      output[:attributes][:gh_languages] = JSON.parse(language_request.body)
    end

    return output

  end

end
